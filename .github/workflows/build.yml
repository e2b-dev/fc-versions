name: Build Firecracker Versions

on:
  workflow_call:
    outputs:
      versions:
        description: "JSON array of versions that were built"
        value: ${{ jobs.prepare.outputs.versions }}
  workflow_dispatch:

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      versions: ${{ steps.set-versions.outputs.versions }}
    steps:
      - uses: actions/checkout@v4

      - name: Parse versions from file
        id: set-versions
        run: |
          # Read versions, skip comments and empty lines, output as JSON array
          versions=$(grep -v '^ *#' firecracker_versions.txt | grep -v '^$' | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "versions=$versions" >> $GITHUB_OUTPUT
          echo "Building versions: $versions"

  build:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        version: ${{ fromJson(needs.prepare.outputs.versions) }}
    steps:
      - uses: actions/checkout@v4

      # Set up Docker Buildx for better caching
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Cache Docker layers
      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: docker-buildx-${{ runner.os }}-${{ matrix.version }}-${{ github.sha }}
          restore-keys: |
            docker-buildx-${{ runner.os }}-${{ matrix.version }}-
            docker-buildx-${{ runner.os }}-

      # Cache Cargo registry and git dependencies
      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: cargo-${{ runner.os }}-${{ matrix.version }}-${{ github.sha }}
          restore-keys: |
            cargo-${{ runner.os }}-${{ matrix.version }}-
            cargo-${{ runner.os }}-

      - name: Build Firecracker ${{ matrix.version }}
        run: ./build.sh "${{ matrix.version }}"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: firecracker-${{ matrix.version }}
          path: builds/
          retention-days: 30
