name: Build Firecracker Versions

on:
  workflow_call:
    outputs:
      versions:
        description: "JSON array of versions that were built"
        value: ${{ jobs.prepare.outputs.versions }}
  workflow_dispatch:

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      versions: ${{ steps.set-versions.outputs.versions }}
    steps:
      - uses: actions/checkout@v4

      - name: Parse versions from file
        id: set-versions
        run: |
          # Read versions, skip comments and empty lines, output as JSON array
          versions=$(grep -v '^ *#' firecracker_versions.txt | grep -v '^$' | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "versions=$versions" >> $GITHUB_OUTPUT
          echo "Building versions: $versions"

  build:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        version: ${{ fromJson(needs.prepare.outputs.versions) }}
    steps:
      - uses: actions/checkout@v4

      - name: Build Firecracker ${{ matrix.version }}
        id: build
        run: |
          ./build.sh "${{ matrix.version }}"
          # Read the computed version name (with hash) - format is "version_name:commit_hash"
          version_info=$(cat built_versions.txt | tail -1)
          version_name=$(echo "$version_info" | cut -d: -f1)
          echo "version_name=$version_name" >> $GITHUB_OUTPUT

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: firecracker-${{ steps.build.outputs.version_name }}
          path: builds/
          retention-days: 7

      - name: Upload version info
        uses: actions/upload-artifact@v4
        with:
          name: version-info-${{ steps.build.outputs.version_name }}
          path: built_versions.txt
          retention-days: 7
